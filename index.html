<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>å„ªæ±°ãã‚“ ã˜ã‹ã‚“ </title>

  <style>
    body {
      font-family: "Yu Gothic", sans-serif;
      background: #eef;
      padding: 20px;
      text-align: center;
    }

    /* å…¨ä½“ã‚’åŒ…ã‚€ã‚³ãƒ³ãƒ†ãƒŠ */
    .board {
      display: inline-block;
    }

    /* æ™‚è¨ˆã®è¡Œã¨ãƒãƒ¼ã®è¡Œã‚’ç¸¦ã«ç©ã‚€ */
    .clocks-row,
    .bars-row {
      display: flex;
      justify-content: flex-start;
      margin: 0;
      padding: 0;
    }

    /* å„æ™‚é–“ã®ã‚»ãƒ«ï¼ˆæ™‚è¨ˆç”¨ï¼ãƒãƒ¼ç”¨ å…±é€šï¼‰ */
    .clock-cell,
    .bar-cell {
      width: 160px;          /* 1æ™‚ã€œ10æ™‚ã®å¹…ã‚’ã™ã¹ã¦å›ºå®š */
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* æ™‚è¨ˆã‚¢ã‚¤ã‚³ãƒ³ */
    .clock {
      width: 80px;
      height: 80px;
      margin: 0;
      padding: 0;
    }

    canvas {
      width: 100%;
      height: 100%;
      display: block;        /* ç”»åƒã®ä¸‹ã®éš™é–“ã‚’æ¶ˆã™ */
    }

    /* æ™‚åˆ»ãƒ©ãƒ™ãƒ«ï¼ˆ1æ™‚ã€œ10æ™‚ï¼‰ */
    .hour-label {
      font-size: 30px;
      margin: 2px 0 4px 0;
      padding: 0;
    }

    /* 1æ™‚é–“ã®ç¸¦é•·ãƒãƒ¼ï¼ˆã‚»ãƒ«å¹…ã„ã£ã±ã„ï¼‰ */
    .hour-bar {
      width: 100%;           /* bar-cell ã®å¹…ã¨ä¸€è‡´ã•ã›ã‚‹ */
      height: 160px;
      background: #eee;
      border: 2px solid #999;
      border-radius: 6px;
      position: relative;
      overflow: hidden;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* èµ¤è‰²ã®å¡—ã‚Šã¤ã¶ã— */
    .fill {
      height: 100%;
      background: #ff6666;
      position: absolute;
      top: 0;
      left: 0;
    }

    /* ãƒ†ãƒ¬ãƒ“è¡¨ç¤º */
    .tv-label {
      font-size: 20px;
      margin-top: 4px;
      color: red;
      font-weight: bold;
      text-align: center;
      width: 100%;
    }

    .tv-icon {
      font-size: 50px;
    }

    /* æ®‹ã‚Šæ™‚é–“ã®è‰² */
    .remain-blue   { color: blue; }
    .remain-orange { color: orange; }
    .remain-red    { color: red; }

    /* ç‚¹æ»…ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes blink {
      0%   { opacity: 1; }
      50%  { opacity: 0; }
      100% { opacity: 1; }
    }

    .blink {
      animation: blink 1s infinite;
    }

    .remain-time {
      font-size: 12px;
      margin-top: 2px;
      font-weight: bold;
    }

    .over-time {
      font-size: 12px;
      color: red;
      margin-top: 2px;
      font-weight: bold;
    }

.event-line {
  position: absolute;
  top: 0;
  width: 10px;          /* å¤ªã• */
  height: 100%;
  background: blue;
  z-index: 5;          /* é€²æ—ãƒãƒ¼ã‚ˆã‚Šä¸Šã«è¡¨ç¤º */
}

.setting-button {
  font-size: 24px;
  padding: 10px 20px;
  margin-bottom: 20px;
  background: #4da3ff;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}

.setting-button:hover {
  background: #1c82e3;
}

.hour-bar {
  width: 100%;
  height: 140px;
  background: #eee;
  border: 2px solid #999;
  border-radius: 6px;
  position: relative;
  overflow: hidden;
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

/* 10åˆ†ã”ã¨ã®åŒºåˆ‡ã‚Šç·š */
.divider {
  position: absolute;
  top: 0;
  width: 1px;
  height: 100%;
  background: rgba(0,0,0,0.15); /* è–„ã„ç·š */
}

  </style>
</head>
<body>
  <h2>å„ªæ±°ãã‚“ ã˜ã‹ã‚“</h2>

<button class="setting-button" onclick="location.href='https://yyyyyasuuuuu-prog.github.io/time/setting.html'">
  âš™
</button>

  <div class="board">
    <div class="clocks-row" id="clocksRow"></div>
    <div class="bars-row" id="barsRow"></div>
  </div>

  <script>

	window.addEventListener("touchstart", () => {
	  silentSound.play().catch(()=>{});
	}, { once: true });

    const API_URL = "https://script.google.com/macros/s/AKfycbzTWTdnqjQ3zoWuiOngmGm3Kqro9FQMx1R3g2x7tMV2MoU2DetU3lMyoBg3G0aqxzsJNQ/exec";
    const clockHours = [6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22];

   let lastDiffLeave = null;

    // éŸ³ãƒ•ã‚¡ã‚¤ãƒ«
    let warningSound = new Audio("sounds/warning.mp3");
    let timeoutSound = new Audio("sounds/timeout.mp3");

    // ç„¡éŸ³ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ0.1ç§’ã®ç„¡éŸ³ mp3 ã‚’ç”¨æ„ã—ã¦ãã ã•ã„ï¼‰
    let silentSound = new Audio("sounds/silent.mp3");

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ç„¡éŸ³ã‚’å†ç”Ÿ â†’ ä»¥é™ã®éŸ³ãŒè¨±å¯ã•ã‚Œã‚‹
    window.addEventListener("load", () => {
      silentSound.play().catch(()=>{});
    });

    function drawClock(canvas, hour) {
      const ctx = canvas.getContext("2d");
      const w = canvas.width, h = canvas.height;
      const r = Math.min(w, h) / 2 - 4;
      const cx = w / 2, cy = h / 2;

      ctx.clearRect(0, 0, w, h);

      ctx.beginPath();
      ctx.arc(cx, cy, r, 0, Math.PI * 2);
      ctx.strokeStyle = "#333";
      ctx.lineWidth = 2;
      ctx.stroke();

      const angleH = ((hour % 12) * Math.PI) / 6;
      const hx = cx + r * 0.5 * Math.sin(angleH);
      const hy = cy - r * 0.5 * Math.cos(angleH);

      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.lineTo(hx, hy);
      ctx.strokeStyle = "#000";
      ctx.lineWidth = 3;
      ctx.stroke();

      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.lineTo(cx, cy - r * 0.7);
      ctx.strokeStyle = "#000";
      ctx.lineWidth = 2;
      ctx.stroke();
    }

    async function loadSetting() {
      const res = await fetch(API_URL);
      return await res.json();
    }

    let lastDiff = null;

	function displayHour(h) {
	  return h <= 12 ? h : h - 12;
	}

    async function render() {
      const tvOffTime = await loadSetting();

      const now = new Date();
      const currentTotal = now.getHours() * 60 + now.getMinutes();
      const tvTotal = tvOffTime.hour * 60 + tvOffTime.minute;

      const clocksRow = document.getElementById("clocksRow");
      const barsRow   = document.getElementById("barsRow");
      
      timeoutSound.loop = true;

      clocksRow.innerHTML = "";
      barsRow.innerHTML   = "";

      clockHours.forEach(hour => {
        const hourStart = hour * 60;
        const hourEnd = hourStart + 60;

        const percent =
          currentTotal >= hourEnd ? 100 :
          currentTotal <= hourStart ? 0 :
          ((currentTotal - hourStart) / 60) * 100;

        const clockCell = document.createElement("div");
        clockCell.className = "clock-cell";

        const canvas = document.createElement("canvas");
        canvas.className = "clock";
        canvas.width = 60;
        canvas.height = 60;
        drawClock(canvas, displayHour(hour));
        clockCell.appendChild(canvas);

        const label = document.createElement("div");
        label.className = "hour-label";
        label.textContent = `${displayHour(hour)}æ™‚`;
        clockCell.appendChild(label);

        clocksRow.appendChild(clockCell);

        const barCell = document.createElement("div");
        barCell.className = "bar-cell";

	const bar = document.createElement("div");
	bar.className = "hour-bar";

	/* â–¼ 10åˆ†ã”ã¨ã®åŒºåˆ‡ã‚Šç·šï¼ˆ6æœ¬ï¼‰ã‚’è¿½åŠ  â–¼ */
	for (let i = 1; i < 6; i++) {
	  const divider = document.createElement("div");
	  divider.className = "divider";
	  divider.style.left = `${(i * 10) / 60 * 100}%`;  // 10åˆ†ã”ã¨ã«é…ç½®
	  bar.appendChild(divider);
	}

	/* â–¼ é€²æ—ãƒãƒ¼ï¼ˆæ¨ªæ–¹å‘ï¼‰ â–¼ */
	const fill = document.createElement("div");
	fill.className = "fill";
	fill.style.width = `${percent}%`;
	bar.appendChild(fill);

	barCell.appendChild(bar);
        // ãƒ†ãƒ¬ãƒ“ã‚’æ¶ˆã™æ™‚é–“
        if (tvTotal >= hourStart && tvTotal < hourEnd) {
          const tv = document.createElement("div");
          tv.className = "tv-label";
          tv.innerHTML = `<div class="tv-icon">ğŸ“º</div>OFF<br>`;
          barCell.appendChild(tv);

          const diff = tvTotal - currentTotal;

          // æ®‹ã‚Šæ™‚é–“ã®è‰²åˆ†ã‘
          if (diff > 0 && diff <= 15) {
            const remain = document.createElement("div");
            remain.className = "remain-time";

            if (diff > 10) remain.classList.add("remain-blue");
            else if (diff > 5) remain.classList.add("remain-orange");
            else remain.classList.add("remain-red", "blink");

            remain.textContent = `ã‚ã¨ ${diff} åˆ†`;
            barCell.appendChild(remain);

            // 5åˆ†å‰ã«ãªã£ãŸç¬é–“ã®éŸ³
            if (lastDiff !== null && lastDiff > 5 && diff <= 5) {
              warningSound.play().catch(()=>{});
            }
          }

          // æ™‚é–“ã‚’éããŸ
          if (diff < 0) {
            const over = document.createElement("div");
            over.className = "over-time";
            over.textContent = `ãƒ†ãƒ¬ãƒ“ã‚’æ¶ˆã™æ™‚é–“ã‚’ã™ãã¾ã—ãŸ`;
            barCell.appendChild(over);

            // æ™‚é–“ã«ãªã£ãŸç¬é–“ã®éŸ³
            if (lastDiff !== null && lastDiff >= 0 && diff < 0) {
              timeoutSound.loop = true;          // â† ãƒ«ãƒ¼ãƒ—å†ç”ŸON

              timeoutSound.play().catch(()=>{});

		  // 60ç§’å¾Œã«åœæ­¢
		  setTimeout(() => {
		    timeoutSound.pause();
		    timeoutSound.currentTime = 0;
		    timeoutSound.loop = false;       // â† ãƒ«ãƒ¼ãƒ—OFFã«æˆ»ã™
		  }, 60000);


            }
          }

          lastDiff = diff;
        }

        barsRow.appendChild(barCell);


	// â–¼ ãƒ†ãƒ¬ãƒ“ã®èµ¤ã„ç¸¦ç·š
	const tvLine = document.createElement("div");
	tvLine.className = "event-line";

	// ä½ç½® = (åˆ† / 60) * 100%
	tvLine.style.left = `${((tvTotal - hourStart) / 60) * 100}%`;

	bar.appendChild(tvLine);





	
    const leaveTotal = tvOffTime.leaveHour * 60 + tvOffTime.leaveMinute;

	// â–¼ å®¶ã‚’å‡ºã‚‹æ™‚é–“ï¼ˆLeave Timeï¼‰
	if (leaveTotal >= hourStart && leaveTotal < hourEnd) {
	  const leave = document.createElement("div");
	  leave.className = "tv-label";
	  leave.innerHTML = `<div class="tv-icon">ğŸ </div>å®¶ã‚’å‡ºã‚‹<br>`;
	  barCell.appendChild(leave);

	  const diff2 = leaveTotal - currentTotal;

	  // æ®‹ã‚Šæ™‚é–“ã®è‰²åˆ†ã‘
	  if (diff2 > 0 && diff2 <= 15) {
	    const remain2 = document.createElement("div");
	    remain2.className = "remain-time";

	    if (diff2 > 10) remain2.classList.add("remain-blue");
	    else if (diff2 > 5) remain2.classList.add("remain-orange");
	    else remain2.classList.add("remain-red", "blink");

	    remain2.textContent = `ã‚ã¨ ${diff2} åˆ†`;
	    barCell.appendChild(remain2);

	    // 5åˆ†å‰ã®éŸ³
	    if (lastDiffLeave !== null && lastDiffLeave > 5 && diff2 <= 5) {
	      warningSound.play().catch(()=>{});
	    }
	  }

	  // æ™‚é–“ã‚’éããŸ
	  if (diff2 < 0) {
	    const over2 = document.createElement("div");
	    over2.className = "over-time";
	    over2.textContent = `å®¶ã‚’å‡ºã‚‹æ™‚é–“ã‚’ã™ãã¾ã—ãŸ`;
	    barCell.appendChild(over2);

	    // æ™‚é–“è¶…éã®éŸ³
	    if (lastDiffLeave !== null && lastDiffLeave >= 0 && diff2 < 0) {
               timeoutSound.loop = true;

	      timeoutSound.play().catch(()=>{});

	  setTimeout(() => {
	    timeoutSound.pause();
	    timeoutSound.currentTime = 0;
	    timeoutSound.loop = false;
	  }, 60000);


	    }
	  }

	  lastDiffLeave = diff2;
	}

	// â–¼ å®¶ã‚’å‡ºã‚‹æ™‚é–“ã®èµ¤ã„ç¸¦ç·š
	const leaveLine = document.createElement("div");
	leaveLine.className = "event-line";

	leaveLine.style.left = `${((leaveTotal - hourStart) / 60) * 100}%`;

	bar.appendChild(leaveLine);





      });
    }



    render();
    setInterval(render, 30000);
  </script>
</body>
</html>
